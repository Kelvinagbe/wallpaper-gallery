import { useEffect, useRef } from 'react';

export const usePrefetch = (images: string[], priority: 'high' | 'low' = 'low') => {
  const prefetchedRef = useRef(new Set<string>());

  useEffect(() => {
    if ('requestIdleCallback' in window) {
      (window as any).requestIdleCallback(() => prefetchImages());
    } else {
      setTimeout(prefetchImages, 100);
    }

    function prefetchImages() {
      images.forEach((src) => {
        if (!src || prefetchedRef.current.has(src)) return;

        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.as = 'image';
        link.href = src;

        if (priority === 'high') {
          link.setAttribute('fetchpriority', 'high');
        }

        document.head.appendChild(link);
        prefetchedRef.current.add(src);
      });
    }

    return () => {
      document.querySelectorAll('link[rel="prefetch"][as="image"]').forEach((link) => {
        if (images.includes(link.getAttribute('href') || '')) {
          link.remove();
        }
      });
    };
  }, [images, priority]);
};